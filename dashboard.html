<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma SDR Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
    // Função para Iniciar Chamadas
window.iniciarChamadas = function() {
    const btn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    btn.disabled = true;
    btn.textContent = 'Iniciando...';
    fetch('/iniciar-chamadas', {method: 'POST'})
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Chamadas iniciadas! Verifique logs.');
                pauseBtn.classList.remove('hidden');
                btn.textContent = 'Rodando...';
            } else {
                alert('Erro: ' + result.message);
                btn.disabled = false;
                btn.textContent = 'Iniciar Chamadas';
            }
        })
        .catch(error => {
            alert('Erro de conexão.');
            btn.disabled = false;
            btn.textContent = 'Iniciar Chamadas';
        });
};

// Função para Parar Chamadas
window.pausarChamadas = function() {
    const btn = document.getElementById('pauseBtn');
    const startBtn = document.getElementById('startBtn');
    btn.textContent = 'Parando...';
    fetch('/parar-chamadas', {method: 'POST'})
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Chamadas paradas!');
                btn.classList.add('hidden');
                startBtn.disabled = false;
                startBtn.textContent = 'Iniciar Chamadas';
            } else {
                alert('Erro: ' + result.message);
            }
        })
        .catch(error => {
            alert('Erro de conexão.');
        });
};
        // Reimportando todos os módulos do Firebase necessários
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logging de debug
        setLogLevel('Debug');

        // Variáveis globais
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- ATENÇÃO: CONFIGURAÇÃO DE CREDENCIAIS DE CLIENTE (Obrigatório) ---
        // Estas credenciais são para o front-end (acesso limitado).
        const firebaseConfig = {
            apiKey: "AIzaSyAtFW6DsnU84YG67tvtWvB4lHWFgNRHGVo",
            authDomain: "ura-dashboard.firebaseapp.com",
            projectId: "ura-dashboard",
            storageBucket: "ura-dashboard.firebasestorage.app",
            messagingSenderId: "951470032643",
            appId: "1:951470032643:web:1cb5f58943815a2db08b36"
        };
        // --- FIM DA SECÇÃO CRÍTICA ---

        window.app = null;
        window.auth = null;
        window.db = null; 
        window.userId = null; 
        window.isAppReady = false;
        let myChart = null;
        let UraUnsubscribe = () => {};
        let ClientUnsubscribe = () => {};

        // --- Funções utilitárias ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const cleanCurrency = (text) => {
            if (typeof text !== 'string') return parseFloat(text) || 0;
            return parseFloat(text.replace(/[R$\.]/g, '').replace(',', '.')) || 0;
        };
        
        const showStatus = (message, isError = false) => {
            const statusMessageEl = document.getElementById('statusMessage');
            if (statusMessageEl) {
                statusMessageEl.textContent = message;
                statusMessageEl.classList.toggle('text-red-600', isError);
                statusMessageEl.classList.toggle('bg-red-100', isError);
                statusMessageEl.classList.toggle('text-gray-600', !isError);
                statusMessageEl.classList.toggle('bg-gray-50', !isError);
            }
        };

        const showMessage = (message, isError) => {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-md z-50 transition-all duration-300 transform animate-pulse`;
            messageBox.textContent = message;
            if (isError) {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else {
                messageBox.classList.add('bg-green-500', 'text-white');
            }
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.remove(), 300);
            }, 3000);
        };
        
        // --- CHART LOGIC ---
        function updateChart(answered, unanswered, converted = 0) {
            const ctx = document.getElementById('myChart');
            if (!ctx) return;

            const data = {
                labels: ['Convertidas (Interesse)', 'Chamada Falhou/Sem Interesse', 'Em Contato/Atendido'],
                datasets: [{
                    label: 'Status da Campanha',
                    data: [converted, unanswered, answered],
                    backgroundColor: ['#3b82f6', '#f43f5e', '#10b981'], 
                    hoverOffset: 4
                }]
            };

            if (myChart) {
                myChart.data = data;
                myChart.update();
            } else {
                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        }
                    }
                });
            }
        }

        // --- APP INITIALIZATION (Firebase Only) ---
        const startFirebaseApp = async () => { 
            showStatus("A iniciar a plataforma e autenticar no Firebase...", false);
            
            try {
                window.app = initializeApp(firebaseConfig);
                window.auth = getAuth(window.app);
                window.db = getFirestore(window.app); 
                
                signInAnonymously(window.auth).catch(error => {
                    console.error("Erro ao tentar autenticar anonimamente. Isso pode ser normal se o token for usado.", error);
                });

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID do Usuário: ${window.userId} (Firebase)`;
                        showStatus("Plataforma pronta. Conectado ao Firebase.");
                    } else {
                        window.userId = 'UNAUTHENTICATED';
                        document.getElementById('userIdDisplay').textContent = `ID do Usuário: ${window.userId}`;
                        showStatus("AVISO: Falha na autenticação do Firebase. Funcionalidades de DB podem falhar.", true);
                    }
                    
                    window.isAppReady = true;

                    const saveClientBtn = document.getElementById('saveClientBtn');
                    if(saveClientBtn) {
                        saveClientBtn.disabled = false;
                        saveClientBtn.textContent = 'Salvar Cliente';
                        saveClientBtn.classList.replace('bg-gray-400', 'bg-emerald-600');
                        saveClientBtn.classList.replace('cursor-not-allowed', 'hover:bg-emerald-700');
                    }
                });

            } catch (error) {
                console.error("Erro fatal ao inicializar o Firebase:", error);
                showStatus("Erro fatal: Não foi possível inicializar o Firebase. Verifique a consola.", true);
                window.isAppReady = true;
            }
        };

        // --- Funções Firebase ---
        
        // Salva cliente no Firebase
        const saveClient = async (data) => {
            if (!window.db || !window.userId || window.userId === 'UNAUTHENTICATED') return false;

            try {
                const clientCollectionPath = `artifacts/${appId}/users/${window.userId}/clients`;
                await addDoc(collection(window.db, clientCollectionPath), data);
                return true;
            } catch (error) {
                console.error("ERRO CRÍTICO (WRITE): Falha ao salvar cliente no Firebase. Verifique as regras de segurança.", error);
                showMessage("ERRO CRÍTICO: Falha de escrita no Firebase. Verifique as regras de segurança.", true);
                return false;
            }
        };
        
        // Busca cliente no Firebase
        const searchClient = async (cpf) => {
            if (!window.db || !window.userId || window.userId === 'UNAUTHENTICATED') return null;

            try {
                const clientCollectionPath = `artifacts/${appId}/users/${window.userId}/clients`;
                const q = query(collection(window.db, clientCollectionPath), where("cpf", "==", cpf));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) return null;
                return querySnapshot.docs[0].data();
            } catch (error) {
                console.error("ERRO CRÍTICO (READ): Falha ao buscar cliente no Firebase. Verifique as regras de segurança.", error);
                showMessage("ERRO: Falha de leitura no Firebase. Verifique as regras de segurança.", true);
                return null;
            }
        };


        // --- DASHBOARD LOGIC (Controller) ---
        
        // CORREÇÃO: Função tradicional para hoisting
        function updateDashboardMetrics(leads) {
            let totalCalls = leads.length;
            let answeredCalls = 0; // Atendido mas neutro (pressinou nada, etc)
            let unansweredCalls = 0; // Não Atendido ou Sem Interesse (pressinou 2)
            let convertedCalls = 0; // Interessado (pressinou 1)
            let callingLeads = 0; // Em Ligação (ou call_pending)

            leads.forEach(lead => {
                if (lead.status === 'answered') {
                    answeredCalls++;
                } else if (lead.status === 'unanswered') {
                    unansweredCalls++;
                } else if (lead.status === 'converted') {
                    convertedCalls++;
                } else if (lead.status === 'call_pending' || lead.status === 'calling') {
                    callingLeads++;
                }
            });

            const totalCallsEl = document.getElementById('totalCallsMetric');
            const answeredCallsEl = document.getElementById('answeredCallsMetric');
            const unansweredCallsEl = document.getElementById('unansweredCallsMetric');
            const convertedCallsEl = document.getElementById('convertedCallsMetric');
            
            if (totalCallsEl) totalCallsEl.textContent = totalCalls;
            if (answeredCallsEl) answeredCallsEl.textContent = answeredCalls + callingLeads;
            if (unansweredCallsEl) unansweredCallsEl.textContent = unansweredCalls; 
            if (convertedCallsEl) convertedCallsEl.textContent = convertedCalls; 
            
            updateChart(answeredCalls + callingLeads, unansweredCalls, convertedCalls);
        }
        
        // =======================================================
        // FUNÇÃO GLOBAL DE DISPARO DE LEADS (AGORA REAL)
        // =======================================================
        window.dispararLeads = async function(e) {
            if (e) e.preventDefault(); 

            const uploadStatusEl = document.getElementById('uploadStatus');
            uploadStatusEl.classList.remove('hidden');
            uploadStatusEl.textContent = 'Aguarde... Enviando arquivo para o servidor e iniciando chamadas...';
            
            const csvFileEl = document.getElementById('csv_file');
            if (csvFileEl.files.length === 0) {
                uploadStatusEl.textContent = 'Erro: Selecione um arquivo CSV/XLS.';
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', csvFileEl.files[0]);

            try {
                // Tenta fazer o upload e iniciar as chamadas Twilio
                const response = await fetch('/upload-leads', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok && result.success) {
    // ... código existente ...
    document.getElementById('startBtn').disabled = false;  // NOVA LINHA: Habilita o botão Iniciar
}

                if (response.ok && result.success) {
                    uploadStatusEl.textContent = result.message;
                    showMessage("Chamadas em Disparo! Monitore o dashboard e o console Twilio.", false);
                    showStatus("Chamadas iniciadas via Twilio. Status em tempo real no dashboard.", false);
                } else {
                    uploadStatusEl.textContent = `Erro do Servidor: ${result.message || 'Falha desconhecida.'}`;
                    showMessage(`Falha ao iniciar URA: ${result.message || 'Verifique o console e o servidor Python.'}`, true);
                    showStatus(`ERRO: Falha ao iniciar URA. ${result.message || 'Verifique o back-end Python/Twilio.'}`, true);
                }
            } catch (error) {
                console.error("Erro ao comunicar com o back-end:", error);
                uploadStatusEl.textContent = 'Erro de Rede: Não foi possível conectar ao back-end da URA. Verifique o servidor Python.';
                showMessage('Erro Crítico de Conexão com o Servidor.', true);
                showStatus('ERRO CRÍTICO: Falha de conexão. O servidor Python está online?', true);
            }
        };

        function setupDashboardLogic() {
            // Configura o Listener do Firebase para o monitoramento em tempo real
            if(window.db && window.userId && window.userId !== 'UNAUTHENTICATED') {
                 // Esta coleção DEVE ser a mesma que o back-end está atualizando
                 const leadsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/ura_leads`);
                
                 UraUnsubscribe = onSnapshot(leadsCollectionRef, (snapshot) => {
                     const leads = snapshot.docs.map(doc => doc.data());
                     updateDashboardMetrics(leads);
                 }, (error) => {
                     console.error("ERRO CRÍTICO (READ): Falha no onSnapshot. Verifique as regras de segurança.", error);
                     showStatus("ERRO CRÍTICO: Falha de leitura em tempo real. Verifique as regras de segurança.", true);
                     UraUnsubscribe(); 
                     updateDashboardMetrics([]); 
                 });
            } else {
                updateDashboardMetrics([]);
            }
        }

        // --- Clientes Logic ---

        // CORREÇÃO: Função tradicional para hoisting
        function updateClientList(clients) {
            const clientListEl = document.getElementById('clientList');
            if (!clientListEl) return;
            clientListEl.innerHTML = '';
                
            if (clients.length === 0) {
                clientListEl.innerHTML = '<li class="text-gray-500 italic">Nenhum cliente salvo ainda.</li>';
                return;
            }

            clients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-emerald-100 hover:shadow-md transition';
                li.innerHTML = `
                    <span class="font-medium text-gray-800">${client.name}</span>
                    <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">
                        ${new Date(client.contractDate).toLocaleDateString('pt-BR')}
                    </span>
                `;
                clientListEl.appendChild(li);
            });
        }
        
        function setupClientLogic() {
            // 1. Client Form Submission (Save)
            const clientForm = document.getElementById('clientForm');
            if(clientForm) {
                clientForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const contractDateValue = document.getElementById('contractDate').value;
                    const contractDateObj = new Date(contractDateValue);
                    
                    const recontactDate = new Date(contractDateObj);
                    recontactDate.setMonth(recontactDate.getMonth() + 1); // 1 mês após o contrato

                    const data = {
                        id: crypto.randomUUID(), 
                        name: document.getElementById('clientName').value,
                        cpf: document.getElementById('clientCpf').value.replace(/\D/g, ''), 
                        benefitNumber: document.getElementById('clientBenefitNumber').value,
                        address: document.getElementById('clientAddress').value,
                        phone: document.getElementById('clientPhone').value,
                        contractDate: contractDateValue,
                        createdAt: new Date().toISOString(), 
                        recontactDue: recontactDate.toISOString() 
                    };

                    const success = await saveClient(data);
                    
                    if (success) {
                        showMessage("Cliente salvo com sucesso!", false);
                        e.target.reset();
                    } else {
                        showMessage("Erro ao salvar cliente. Verifique o console.", true);
                    }
                });
            }

            // 2. Client Search (Get by CPF)
            const searchForm = document.getElementById('searchForm');
            if(searchForm) {
                searchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const searchCpf = document.getElementById('searchCpf').value.replace(/\D/g, '');
                    const clientDetailsEl = document.getElementById('clientDetails');

                    if (!searchCpf) {
                        clientDetailsEl.innerHTML = '<span class="text-red-500">Por favor, digite um CPF para buscar.</span>';
                        return;
                    }

                    clientDetailsEl.innerHTML = '<span class="text-blue-500 font-bold animate-pulse">Buscando cliente...</span>';

                    const clientData = await searchClient(searchCpf);

                    if (!clientData) {
                        clientDetailsEl.innerHTML = `<span class="text-orange-500">Nenhum cliente encontrado com o CPF: ${searchCpf}.</span>`;
                        return;
                    }
                    
                    // As datas são salvas como string ISO
                    const recontactDate = new Date(clientData.recontactDue);
                    
                    clientDetailsEl.innerHTML = `
                        <h4 class="font-extrabold text-lg text-emerald-700">${clientData.name}</h4>
                        <p><strong>CPF:</strong> ${clientData.cpf}</p>
                        <p><strong>Benefício:</strong> ${clientData.benefitNumber || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${clientData.phone}</p>
                        <p><strong>Endereço:</strong> ${clientData.address}</p>
                        <p class="mt-4 p-2 bg-yellow-100 rounded-lg">
                            <strong>Contrato Finalizado em:</strong> ${new Date(clientData.contractDate).toLocaleDateString('pt-BR')}
                        </p>
                        <p class="font-bold text-green-700 mt-2">
                            Sugestão de Recontacto: ${recontactDate.toLocaleDateString('pt-BR')}
                        </p>
                    `;
                });
            }

            // 3. Client List Listener (Firebase)
            if(window.db && window.userId && window.userId !== 'UNAUTHENTICATED') {
                 const clientCollectionPath = `artifacts/${appId}/users/${window.userId}/clients`;
                 
                 ClientUnsubscribe = onSnapshot(collection(window.db, clientCollectionPath), (snapshot) => {
                     const clients = snapshot.docs.map(doc => doc.data());
                     updateClientList(clients);
                 }, (error) => {
                     console.error("ERRO CRÍTICO (READ): Falha no onSnapshot de clientes. Verifique as regras de segurança.", error);
                     showMessage("ERRO CRÍTICO: Falha de leitura de clientes. Verifique as regras de segurança.", true);
                     ClientUnsubscribe(); 
                     updateClientList([]); // Limpa a lista se falhar
                 });
            } else {
                updateClientList([]);
            }
        }

        // --- O restante das funções (LEAD SIMULATOR CORE LOGIC, parseLeadData, etc.) permanecem inalteradas ---
        
        function calculateLeadPotential(installmentsPaid, totalInstallments, installmentValue, originalTax, newCoeficiente) {
            
            const remainingTerms = totalInstallments - installmentsPaid;
            const sdFactor = (remainingTerms / totalInstallments) * 0.8;
            const approxSD = sdFactor * installmentValue * totalInstallments;
            const newMaxLoan = installmentValue / newCoeficiente * remainingTerms; 
            const valorLiberado = newMaxLoan - approxSD;

            return {
                remainingTerms,
                approxSD: approxSD > 0 ? approxSD : 0, 
                newMaxLoan,
                valorLiberado: valorLiberado > 0 ? valorLiberado : 0, 
                savingsRate: originalTax - (newCoeficiente * 100)
            };
        }

        function parseLeadData(text) {
            const data = {};
            const lines = text.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                const [key, value] = line.split(':').map(s => s.trim());
                if (key && value) {
                    data[key.toLowerCase().replace(/ /g, '_')] = value;
                }
            });

            const extractMatch = (regex) => {
                const match = text.match(regex);
                return match && match[1] ? match[1].trim() : 'Não informado';
            };
            
            const nome = extractMatch(/Nome:\s*(.*)/i);
            const cpf = extractMatch(/CPF:\s*(.*)/i);
            const foneCliente = extractMatch(/Fone Cliente:\s*(.*)/i);
            const beneficio = extractMatch(/Beneficio:\s*(.*)/i);
            const especie = extractMatch( /Espécie:\s*(.*)/i);
            const dataNascimentoStr = extractMatch(/Data Nascimento:\s*([\d\/]+)/i);

            let idade = 'Não informada';
            if (dataNascimentoStr && dataNascimentoStr !== 'Não informado') {
                const partesData = dataNascimentoStr.split('/');
                const dataNascimento = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                const hoje = new Date();
                let idadeCalculada = hoje.getFullYear() - dataNascimento.getFullYear();
                const m = hoje.getMonth() - dataNascimento.getMonth();
                if (m < 0 || (m === 0 && hoje.getDate() < dataNascimento.getDate())) {
                    idadeCalculada--;
                }
                idade = idadeCalculada;
            }

            return {
                nome,
                cpf,
                fone_cliente: foneCliente,
                beneficio,
                especie,
                idade,
                salario: cleanCurrency(data.salario || '0'),
                margem_emprestimo: cleanCurrency(data.margem_emprestimo || '0'),
                margem_cartao: cleanCurrency(data.margem_cartao || '0'),
            };
        }

        function parseContracts(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const parts = line.split(/\s+/).filter(p => p.trim() !== '');
                
                // Formato esperado: ID Banco Data_Inicio Valor_Total Parcela Prazo_Total Parcelas_Pagas Valor_Restante Taxa_Original (9 campos)
                if (parts.length >= 9) {
                    return {
                        contractId: parts[0],
                        bank: parts[1], 
                        startDate: parts[2],
                        totalValue: cleanCurrency(parts[3]),
                        installment: cleanCurrency(parts[4]),
                        totalTerms: parseInt(parts[5]),
                        installmentsPaid: parseInt(parts[6]),
                        remainingValue: cleanCurrency(parts[7]),
                        originalTax: cleanCurrency(parts[8]) // Taxa em % (Ex: 1.75)
                    };
                }
                return null;
            }).filter(c => c !== null);
        }

        window.processarLead = function() {
            const textoLead = document.getElementById('textoLead').value;
            const textoContratos = document.getElementById('textoContratos').value;
            const novoCoeficiente = parseFloat(document.getElementById('novoCoeficiente').value);
            const novaTaxa = parseFloat(document.getElementById('novaTaxa').value);
            const resultadosEl = document.getElementById('resultados');

            if (!textoLead || !textoContratos || isNaN(novoCoeficiente) || novoCoeficiente <= 0) {
                resultadosEl.innerHTML = '<p class="text-red-600 font-bold">Por favor, preencha o texto do Lead, a Tabela de Contratos e o Novo Coeficiente (maior que zero).</p>';
                resultadosEl.classList.remove('hidden');
                return;
            }
            
            resultadosEl.innerHTML = `
                <div class="flex justify-center items-center py-8">
                    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    <span class="ml-4 text-gray-500">A processar dados e calcular potencial...</span>
                </div>
            `;
            resultadosEl.classList.remove('hidden');

            setTimeout(() => { // Simula o tempo de processamento
                
                const leadData = parseLeadData(textoLead);
                const contracts = parseContracts(textoContratos);
                
                const coeficienteRefin = 0.02300; 
                
                let parcelaTotal = 0;
                let saldoTotal = 0;
                let totalVlEmprestado = 0;
                let contratosDetalhes = [];


                // Processamento de Contratos
                contracts.forEach(contract => {
                    const vlParcela = contract.installment;
                    const saldo = contract.remainingValue;
                    
                    const potential = calculateLeadPotential(
                        contract.installmentsPaid, contract.totalTerms, vlParcela, contract.originalTax, novoCoeficiente
                    );

                    parcelaTotal += vlParcela;
                    saldoTotal += saldo;
                    totalVlEmprestado += contract.totalValue;

                    contratosDetalhes.push({
                        ...contract,
                        valorLiberado: potential.valorLiberado,
                        approxSD: potential.approxSD,
                        vlEmprestado: contract.totalValue,
                        parcela: vlParcela,
                        saldo: saldo,
                    });
                });
                
                // --- Simulações Adicionais ---
                
                let simulacaoMargem = null;
                if (leadData.margem_emprestimo > 0) {
                    const valorLiberado = leadData.margem_emprestimo / novoCoeficiente * 84;
                    simulacaoMargem = { parcela: leadData.margem_emprestimo, valorLiberado: valorLiberado };
                }

                let simulacaoRC = null;
                if (parcelaTotal > 0 && !isNaN(novoCoeficiente) && novoCoeficiente > 0) {
                    const maxLoan = (parcelaTotal / novoCoeficiente) * 84; 
                    const valorLiberado = maxLoan - saldoTotal;
                    simulacaoRC = {
                        parcela: parcelaTotal,
                        coeficiente: novoCoeficiente,
                        taxa: novaTaxa,
                        valorLiberado: valorLiberado
                    };
                }

                // --- Pontuação e Ações ---

                let pontuacao = 0;
                let acoes = [];
                let totalPotential = 0;
                
                if (leadData.salario > 2500) { pontuacao += 20; }
                if (leadData.nome !== 'Não informado') { pontuacao += 30; }
                if (typeof leadData.idade === 'number' && leadData.idade >= 18 && leadData.idade < 60) { pontuacao += 10; }

                if (leadData.margem_emprestimo > 0) {
                    acoes.push(`O lead tem margem livre disponível de ${formatCurrency(leadData.margem_emprestimo)} para um novo contrato.`);
                    pontuacao += 25;
                } else {
                    acoes.push("O lead não tem margem de empréstimo disponível. Foco em refinanciamento e portabilidade.");
                }
                
                if (contratosDetalhes.length > 0) {
                    acoes.push(`O lead possui ${contratosDetalhes.length} contratos com saldo devedor (${formatCurrency(saldoTotal)}). Avaliar a portabilidade para liberação de troco.`);
                    pontuacao += 15;
                    
                    contratosDetalhes.forEach(c => {
                        totalPotential += c.valorLiberado > 0 ? c.valorLiberado : 0;
                        if (c.installmentsPaid && c.totalTerms && c.installmentsPaid / c.totalTerms > 0.5) {
                            acoes.push(`O contrato com o banco ${c.bank} está com mais de 50% das parcelas pagas, excelente para portabilidade.`);
                        }
                    });
                }
                
                if (totalPotential > 5000) {
                    acoes.push(`ALTO POTENCIAL DE TROCO: A portabilidade/refinanciamento dos contratos pode liberar mais de ${formatCurrency(5000)}.`);
                    pontuacao += 10;
                }

                if (leadData.margem_cartao > 0) {
                    acoes.push("Há margem para cartão consignado. Sugerir a oferta de cartão consignado/saque.");
                    pontuacao += 10;
                }

                pontuacao = Math.min(pontuacao, 100);
                let status, classe_css;
                if (pontuacao >= 70) {
                    status = "Alto";
                    classe_css = "qualidade-alta";
                } else if (pontuacao >= 40) {
                    status = "Médio";
                    classe_css = "qualidade-media";
                } else {
                    status = "Baixo";
                    classe_css = "qualidade-baixa";
                }

                // --- Geração do HTML ---
                
                const htmlContratos = contratosDetalhes.map(c => {
                    const lib = Math.max(0, c.valorLiberado);
                    const contractClass = lib > 0 ? 'bg-green-50' : 'bg-red-50';
                    return `
                    <li class="p-4 rounded-xl shadow-md border border-gray-100 ${contractClass}">
                        <p class="font-bold text-lg text-gray-900">${c.bank} - Contrato ${c.contractId}</p>
                        <ul class="space-y-1 text-sm text-gray-700 mt-2">
                            <li><span class="font-semibold">Vl. Parcela:</span> ${formatCurrency(c.parcela)}</li>
                            <li><span class="font-semibold">Prazo (R/T):</span> ${c.totalTerms - c.installmentsPaid}/${c.totalTerms} meses</li>
                            <li><span class="font-semibold">Saldo Devedor:</span> ${formatCurrency(c.approxSD)}</li>
                            <li><span class="font-semibold">Taxa Original:</span> ${c.originalTax.toFixed(2)}%</li>
                            <li class="mt-2 text-md font-bold ${lib > 0 ? 'text-emerald-700' : 'text-rose-700'}">
                                Potencial Liberação (Nova Taxa): ${formatCurrency(lib)}
                            </li>
                        </ul>
                    </li>
                    `;
                }).join('');

                const htmlSimulacaoMargem = simulacaoMargem ? `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mt-4">
                        <h3 class="text-lg font-bold text-blue-800 mb-2">Simulação de Novo Contrato</h3>
                        <p class="text-blue-600">Com a margem disponível (${formatCurrency(simulacaoMargem.parcela)}), é possível liberar <span class="font-bold">${formatCurrency(simulacaoMargem.valorLiberado)}</span> (em 84x).</p>
                    </div>
                ` : '';

                const htmlSimulacaoRC = simulacaoRC && simulacaoRC.valorLiberado > 0 ? `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mt-4">
                        <h3 class="text-lg font-bold text-indigo-800 mb-2">Potencial de Troco da Portabilidade</h3>
                        <p class="text-indigo-600">
                            Ao portar os contratos para a taxa de ${simulacaoRC.taxa.toFixed(2)}% (Coeficiente ${simulacaoRC.coeficiente.toFixed(5)}), é possível liberar <span class="text-xl font-extrabold">${formatCurrency(Math.max(0, simulacaoRC.valorLiberado))}</span> de troco (em 84x).
                        </p>
                    </div>
                ` : (simulacaoRC ? `
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">
                        <h3 class="text-lg font-bold text-red-800 mb-2">Potencial de Troco da Portabilidade</h3>
                        <p class="text-red-600">A portabilidade para a taxa de ${simulacaoRC.taxa.toFixed(2)}% não gera troco significativo.</p>
                    </div>
                ` : '');
                
                // Resumo Final
                const totalCreditoNovo = (simulacaoMargem ? simulacaoMargem.valorLiberado : 0) + (simulacaoRC ? Math.max(0, simulacaoRC.valorLiberado) : 0);

                resultadosEl.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Resultado da Qualificação</h2>
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <p class="text-xl font-semibold">Lead: ${leadData.nome}</p>
                            </div>
                            <div class="p-2 px-4 rounded-full font-bold text-sm text-white ${classe_css}-bg">
                                <span class="text-gray-800">Score:</span> ${pontuacao}/100
                            </div>
                        </div>
                        <p class="text-lg mb-2">Qualificação: <span class="font-bold ${classe_css}">${status}</span></p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-700 mb-2">Dados Chave do Lead</h3>
                                <ul class="list-none space-y-2 text-gray-600">
                                    <li><span class="font-semibold">CPF:</span> ${leadData.cpf}</li>
                                    <li><span class="font-semibold">Telefone:</span> ${leadData.fone_cliente}</li>
                                    <li><span class="font-semibold">Margem de Empréstimo:</span> ${formatCurrency(leadData.margem_emprestimo)}</li>
                                    <li><span class="font-semibold">Margem de Cartão:</span> ${formatCurrency(leadData.margem_cartao)}</li>
                                    <li><span class="font-semibold">Saldo Devedor Total:</span> ${formatCurrency(saldoTotal)}</li>
                                </ul>
                                ${htmlSimulacaoMargem}
                                ${htmlSimulacaoRC}
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-700 mb-2">Plano de Ação </h3>
                                <ul class="list-disc pl-6 space-y-2 text-gray-600">
                                    ${acoes.map(acao => `<li>${acao}</li>`).join('')}
                                </ul>
                                <div class="mt-6 p-4 bg-purple-100 rounded-lg">
                                    <h4 class="text-lg font-extrabold text-purple-800">Potencial Total (Novo Crédito)</h4>
                                    <p class="text-2xl font-bold text-purple-700">${formatCurrency(totalCreditoNovo)}</p>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">Análise de Contratos Individuais</h3>
                        <ul class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            ${htmlContratos}
                            ${contratosDetalhes.length === 0 ? `
                                <div class="col-span-full bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                                    <p class="font-bold">Aviso: Nenhum contrato encontrado</p>
                                    <p>Verifique se a tabela de contratos está no formato correto (9 colunas separadas por espaço).</p>
                                </div>
                            ` : ''}
                        </ul>
                    </div>
                `;
                
            }, 500);
        }

        function setupTabs() {
            const tabs = {
                'tab-dashboard': 'content-dashboard',
                'tab-sdr': 'content-sdr',
                'tab-simulator': 'content-simulator',
                'tab-clients': 'content-clients',
                'tab-lead-simulator': 'content-lead-simulator'
            };

            const tabButtons = document.querySelectorAll('[id^="tab-"]');
            const tabContents = document.querySelectorAll('[id^="content-"]');

            const switchTab = (activeTabId) => {
                const activeContentId = tabs[activeTabId];

                tabButtons.forEach(btn => {
                    const isActive = btn.id === activeTabId;
                    btn.classList.toggle('text-blue-600', isActive);
                    btn.classList.toggle('border-blue-600', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                    btn.classList.toggle('hover:text-gray-700', !isActive);
                    btn.classList.toggle('hover:border-gray-300', !isActive);
                });

                tabContents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== activeContentId);
                });
            };

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.id));
            });
            
            switchTab('tab-dashboard'); 
        }
        
        // --- DOM CONTENT LOADED ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            updateChart(0, 0, 0); 
            
            setupDashboardLogic(); 
            setupClientLogic(); 

            startFirebaseApp(); 
        });
        
    </script>

    <style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7f9fb; 
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    /* Cores de Qualificação */
    .qualidade-baixa { color: #f44336; }
    .qualidade-media { color: #ff9800; }
    .qualidade-alta { color: #22c55e; }
    .qualidade-baixa-bg { background-color: #fca5a5; }
    .qualidade-media-bg { background-color: #fcd34d; }
    .qualidade-alta-bg { background-color: #86efac; }
    </style>

</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div class="bg-white p-6 sm:p-10 rounded-3xl shadow-2xl max-w-6xl w-full">
        <img src="https://gobocred.com/images/logo.png" alt="Logo da GoboCred" class="mx-auto h-20 w-auto mb-4">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center mb-2">Plataforma SDR Inteligente</h1>
        <p class="text-gray-500 text-center mb-4 max-w-lg mx-auto">
            Central de controlo para URA, SDR IA, simulação de roteiros bancários e análise de clientes.
        </p>
        <div id="userIdDisplay" class="text-gray-400 text-xs text-center mb-8">ID do Usuário: Carregando...</div>

        <div class="w-full">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                    <button id="tab-dashboard" class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 00-1 1v2a1 1 0 102 0V4a1 1 0 00-1-1zM5 9a1 1 0 00-1 1v2a1 1 0 102 0v-2a1 1 0 00-1-1zM15 9a1 1 0 00-1 1v2a1 1 0 102 0v-2a1 1 0 00-1-1zM3 15a1 1 0 00-1 1v2a1 1 0 102 0v-2a1 1 0 00-1-1zM17 15a1 1 0 00-1 1v2a1 1 0 102 0v-2a1 1 0 00-1-1z"></path></svg>
                        <span>Dashboard URA</span>
                    </button>
                    <button id="tab-sdr" class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-2 2a1 1 0 100 2h4a1 1 0 100-2h-4z" clip-rule="evenodd" /></svg>
                        <span>SDR IA</span>
                    </button>
                    <button id="tab-simulator" class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13 14a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1v-2zM9 8a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1V8zM5 2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H6a1 1 0 01-1-1V2z"></path></svg>
                        <span>Simulador de Roteiros</span>
                    </button>
                    <button id="tab-clients" class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <span>Análise de Clientes</span>
                    </button>
                    <button id="tab-lead-simulator" class="tab-button group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 6a1 1 0 011 1v1a1 1 0 11-2 0V9a1 1 0 011-1zm0 6a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5 3a1 1 0 100 2h1a1 1 0 100-2H5zm0 6a1 1 0 100 2h1a1 1 0 100-2H5zm0 6a1 1 0 100 2h1a1 1 0 100-2H5zm10-9a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm0 6a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm0 6a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Simulador</span>
                    </button>
                </nav>
            </div>

            <!-- Dashboard URA -->
            <div id="content-dashboard" class="mt-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-6">
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner flex flex-col items-start">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Métricas Chave</h2>
                            <div class="w-full grid grid-cols-4 gap-4 text-center">
                                <div class="bg-blue-100 p-4 rounded-xl shadow-sm">
                                    <span id="totalCallsMetric" class="block text-2xl font-bold text-blue-800">0</span>
                                    <span class="text-sm text-blue-700">Total de Leads</span>
                                </div>
                                <div class="bg-emerald-100 p-4 rounded-xl shadow-sm">
                                    <span id="answeredCallsMetric" class="block text-2xl font-bold text-emerald-800">0</span>
                                    <span class="text-sm text-emerald-700">Em Contato/Atendido</span>
                                </div>
                                <div class="bg-rose-100 p-4 rounded-xl shadow-sm">
                                    <span id="unansweredCallsMetric" class="block text-2xl font-bold text-rose-800">0</span>
                                    <span class="text-sm text-rose-700">Não Atendidas/Sem Interesse</span>
                                </div>
                                <div class="bg-indigo-100 p-4 rounded-xl shadow-sm">
                                    <span id="convertedCallsMetric" class="block text-2xl font-bold text-indigo-800">0</span>
                                    <span class="text-sm text-indigo-700">Interessados (Converted)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BLOCO: CARREGAMENTO DE LEADS (AGORA VIA UPLOAD REAL) -->
                        <div class="bg-blue-50 p-6 rounded-2xl shadow-inner">
                            <h2 class="text-xl font-semibold text-blue-900 mb-4">Carregamento de Leads (URA Real)</h2>
                            <p class="text-sm text-gray-600 mb-3">Selecione seu arquivo CSV/XLS. O back-end fará as chamadas reais via Twilio. (O arquivo deve ter colunas 'name' e 'phone').</p>
                            <form id="uploadForm" class="flex flex-col gap-3">
                                <div class="flex flex-col gap-3">
                                    <label for="csv_file" id="fileLabel" class="cursor-pointer bg-blue-100 hover:bg-blue-200 transition duration-300 text-blue-700 px-4 py-3 rounded-xl font-medium shadow-sm text-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M.5 4a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 .5.5V13a.5.5 0 0 1-1 0V4z" clip-rule="evenodd" /></svg>
                                        <span id="fileLabelText">Escolher Arquivo CSV/XLS</span>
                                        <input type="file" name="csv_file" class="hidden" id="csv_file" accept=".csv, .xls, .xlsx" required />
                                    </label>
                                </div>
                                <button type="button" onclick="dispararLeads(event)" id="uploadBtn" class="bg-blue-600 hover:bg-blue-700 transition duration-300 text-white px-6 py-3 rounded-xl font-semibold shadow-md">
                                    Disparar Chamadas Reais (Twilio)
                                </button>
                                <button type="button" onclick="iniciarChamadas()" id="startBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold shadow-md mt-2 disabled:bg-gray-400" disabled>
    Iniciar Chamadas
</button>
<button type="button" onclick="pausarChamadas()" id="pauseBtn" class="bg-red-500 text-white px-4 py-2 rounded mt-2 hidden">
    Parar Chamadas
</button>
                            </form>
                            <p id="uploadStatus" class="mt-4 text-sm text-blue-600 font-semibold hidden animate-pulse"></p>
                        </div>
                        
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner text-left">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Log de Status</h2>
                            <p id="statusMessage" class="text-gray-600 text-sm italic">
                                Use o botão acima para carregar leads. Monitore o status das chamadas em tempo real.
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-6">
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Estatísticas da Campanha</h2>
                            <canvas id="myChart" class="w-full h-64"></canvas>
                        </div>
                        <div class="bg-emerald-50 p-6 rounded-2xl shadow-inner">
                            <h2 class="text-xl font-semibold text-emerald-900 mb-4">Ação URA</h2>
                            <p class="text-sm text-gray-600 mb-3">As chamadas são iniciadas automaticamente pelo back-end após o upload.</p>
                            <div class="flex items-center justify-center gap-6">
                                <p class="text-lg font-bold text-gray-700">Status: Aguardando Leads...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SDR IA -->
            <div id="content-sdr" class="mt-8 hidden">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Módulo SDR IA para Correspondentes Bancários</h2>
                    <p class="text-gray-500 mb-6 text-center">
                        Crie roteiros de chamadas personalizados para os seus leads com base em inteligência artificial.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <form id="sdrForm" class="flex flex-col gap-4">
                                <h3 class="text-lg font-bold text-gray-900">Gerar Roteiro</h3>
                                <div class="flex flex-col">
                                    <label for="leadName" class="text-sm font-medium text-gray-700">Nome do Lead:</label>
                                    <input type="text" id="leadName" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200" placeholder="Ex: João Silva">
                                </div>
                                <div class="flex flex-col">
                                    <label for="productType" class="text-sm font-medium text-gray-700">Tipo de Produto:</label>
                                    <select id="productType" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
                                        <option value="">Selecione...</option>
                                        <option value="consignado">Crédito Consignado</option>
                                        <option value="financiamento_imovel">Financiamento Imobiliário</option>
                                        <option value="financiamento_veiculo">Financiamento de Veículo</option>
                                        <option value="credito_pessoal">Crédito Pessoal</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label for="leadStatus" class="text-sm font-medium text-gray-700">Status do Lead:</label>
                                    <select id="leadStatus" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
                                        <option value="">Selecione...</option>
                                        <option value="quente">Quente (já demonstrou interesse)</option>
                                        <option value="morno">Morno (interagiu, mas não confirmou)</option>
                                        <option value="frio">Frio (novo contacto)</option>
                                    </select>
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 transition duration-300 text-white px-6 py-3 rounded-xl font-semibold shadow-md">
                                    Gerar Roteiro IA
                                </button>
                            </form>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner overflow-y-auto max-h-96">
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Roteiro Gerado:</h3>
                            <div id="sdrResult" class="text-gray-700 text-sm leading-relaxed italic">
                                Preencha o formulário para gerar um roteiro de chamada personalizado.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulador de Roteiros -->
            <div id="content-simulator" class="mt-8 hidden">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Simulador de Roteiros de Atendimento</h2>
                    <p class="text-gray-500 mb-6 text-center">
                        Simule a conversa com a URA e veja como os roteiros bancários funcionam.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="flex flex-col gap-4">
                                <label for="bankSelect" class="text-sm font-medium text-gray-700">Selecione o Banco:</label>
                                <select id="bankSelect" class="p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
                                    <option value="">Selecione...</option>
                                    <option value="itau">Itaú</option>
                                    <option value="santander">Santander</option>
                                    <option value="caixa">Caixa</option>
                                    <option value="bradesco">Bradesco</option>
                                    <option value="bancodobrasil">Banco do Brasil</option>
                                    <option value="c6bank">C6 Bank</option>
                                    <option value="qualibank">QualiBank</option>
                                    <option value="bancohappy">Banco Happy</option>
                                    <option value="brb">Banco BRB</option>
                                    <option value="picpay">URA PicPay</option>
                                    <option value="banrisul">Banrisul</option>
                                    <option value="digio">Banco Digio</option>
                                </select>
                                <button id="simulateBtn" class="bg-purple-600 hover:bg-purple-700 transition duration-300 text-white px-6 py-3 rounded-xl font-semibold shadow-md mt-4">
                                    Iniciar Simulação
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner overflow-y-auto max-h-96">
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Log da Simulação: </h3>
                            <div id="simulatorLog" class="text-gray-700 text-sm leading-relaxed italic">
                                Selecione um banco e clique em "Iniciar Simulação" para começar.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análise de Clientes -->
            <div id="content-clients" class="mt-8 hidden">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Análise de Clientes</h2>
                    <p class="text-gray-500 mb-6 text-center">
                        Gerir e visualizar clientes com contratos finalizados.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <form id="clientForm" class="flex flex-col gap-4 mb-8">
                                <h3 class="text-lg font-bold text-gray-900">Salvar Cliente</h3>
                                <div class="flex flex-col">
                                    <label for="clientName" class="text-sm font-medium text-gray-700">Nome:</label>
                                    <input type="text" id="clientName" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" placeholder="Nome Completo" required>
                                </div>
                                <div class="flex flex-col">
                                    <label for="clientCpf" class="text-sm font-medium text-gray-700">CPF:</label>
                                    <input type="text" id="clientCpf" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" placeholder="000.000.000-00" required>
                                </div>
                                <div class="flex flex-col">
                                    <label for="clientBenefitNumber" class="text-sm font-medium text-gray-700">Número do Benefício:</label>
                                    <input type="text" id="clientBenefitNumber" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" placeholder="Número do Benefício">
                                </div>
                                <div class="flex flex-col">
                                    <label for="clientAddress" class="text-sm font-medium text-gray-700">Endereço:</label>
                                    <input type="text" id="clientAddress" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" placeholder="Rua, Número, Bairro">
                                </div>
                                <div class="flex flex-col">
                                    <label for="clientPhone" class="text-sm font-medium text-gray-700">Telefone:</label>
                                    <input type="text" id="clientPhone" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" placeholder="(99) 99999-9999">
                                </div>
                                <div class="flex flex-col">
                                    <label for="contractDate" class="text-sm font-medium text-gray-700">Data de Finalização do Contrato:</label>
                                    <input type="date" id="contractDate" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-emerald-200" required>
                                </div>
                                <button id="saveClientBtn" type="submit" class="bg-gray-400 text-white px-6 py-3 rounded-xl font-semibold shadow-md cursor-not-allowed" disabled>
                                    Aguarde...
                                </button>
                            </form>
                            <form id="searchForm" class="flex flex-col gap-4">
                                <h3 class="text-lg font-bold text-gray-900">Buscar por CPF</h3>
                                <div class="flex flex-col">
                                    <label for="searchCpf" class="text-sm font-medium text-gray-700">CPF:</label>
                                    <input type="text" id="searchCpf" class="mt-1 p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200" placeholder="Digite o CPF">
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 transition duration-300 text-white px-6 py-3 rounded-xl font-semibold shadow-md">
                                    Buscar
                                </button>
                            </form>
                        </div>
                        <div>
                            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-8 overflow-y-auto max-h-96">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">Detalhes do Cliente</h3>
                                <div id="clientDetails" class="text-gray-700 text-sm leading-relaxed italic">
                                    Busque um cliente para ver os detalhes.
                                </div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner overflow-y-auto max-h-96">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">Clientes Salvos</h3>
                                <ul id="clientList" class="list-none space-y-2">
                                    <li class="text-gray-500 italic">Carregando lista...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulador de Leads (Financeiro) -->
            <div id="content-lead-simulator" class="mt-8 hidden">
                <div class="max-w-4xl w-full mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">SDR IA - Simulador de Leads</h2>
                    <p class="text-gray-500 text-center mb-6 max-w-lg mx-auto">
                        Cole os dados do lead e a tabela de contratos para obter uma análise detalhada e um plano de ação.
                    </p>

                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="flex flex-col">
                            <h3 class="text-lg font-bold mb-2 text-gray-700">1. Dados do Lead (Texto)</h3>
                            <textarea id="textoLead" rows="8" placeholder="Cole o primeiro bloco de dados aqui...
Ex:
Nome: João da Silva
Data Nascimento: 15/05/1980
Salario: 3.500,00
Margem Empréstimo: 1.050,00
Margem Cartão: 50,00
Fone Cliente: (99) 99999-9999" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300"></textarea>
                        </div>
                        
                        <div class="flex flex-col">
                            <h3 class="text-lg font-bold mb-2 text-gray-700">2. Tabela de Contratos</h3>
                            <textarea id="textoContratos" rows="8" placeholder="Cole a tabela de contratos aqui...
Formato: ID Banco Data_Inicio Valor_Total Parcela Prazo_Total Parcelas_Pagas Valor_Restante Taxa_Original
Ex:
123456 Itaú 01/2022 15000,00 350,00 72 24 10000,00 1,75
789012 BB 05/2021 8000,00 200,00 96 36 6000,00 1,65" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300"></textarea>
                        </div>
                        <div class="flex flex-col">
                            <h3 class="text-lg font-bold mb-2 text-gray-700">3. Coeficiente / Taxa de Juros</h3>
                            <label for="novoCoeficiente" class="text-sm text-gray-500 mb-1">Novo Coeficiente de Simulação:</label>
                            <input type="number" id="novoCoeficiente" step="0.00001" placeholder="Ex: 0.02250 (mensal)" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300 mb-4"/>
                            <label for="novaTaxa" class="text-sm text-gray-500 mb-1">Nova Taxa de Juros (% a.m. para cálculo):</label>
                            <input type="number" id="novaTaxa" step="0.01" placeholder="Ex: 1.85" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300"/>
                        </div>
                    </div>

                    <button onclick="processarLead()" class="w-full bg-purple-600 text-white p-4 rounded-xl font-semibold hover:bg-purple-700 transition-colors shadow-md">
                        Processar Dados e Qualificar
                    </button>

                    <div id="resultados" class="mt-8 pt-6 border-t border-gray-200 hidden">
                        <!-- Os resultados serão injetados aqui via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
